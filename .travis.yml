# Copyright (c) 2009--2021, the KLFitter developer team
#
# This file is part of KLFitter.
#
# KLFitter is free software: you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, either version 3 of the License, or (at
# your option) any later version.
#
# KLFitter is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public
# License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with KLFitter. If not, see <http://www.gnu.org/licenses/>.

language: cpp
services: docker
os: linux
dist: xenial

# Add the doxygen package from apt. Doxygen is needed to
# automatically build and deploy the reference guide online to
# https://KLFitter.github.io.
addons:
  apt:
    packages:
      - doxygen


# Definition of global variables. These include:
#   - BATINSTALLDIR: the directory to install BAT into.
#   - DOCKER_IMAGE: the name of the ROOT docker image.
#   - DOCKER_CONTAINER: internal name to identify the docker
#       container with the ROOT docker image.
#   - KLF_SOURCE_DIR: location of the KLFitter source code.
#   - KLF_BUILD_DIR: directory to be used for the KLFitter build.
#   - CMD_DOCKER: command to be appended to other shell commands
#       when executing them in the docker image.
#   - CMD_EXPORT_BATINSTALL: command to export the variable
#       BATINSTALLDIR within the docker image.
#   - CMD_EXPORT_LIBPATH: command to export the library paths
#       within the docker image. The command appends to an
#       existing LD_LIBRARY_PATH and adds the library locations
#       for ROOT, BAT, and KLFitter.
env:
  global:
    - BATINSTALLDIR="$TRAVIS_BUILD_DIR/external/BAT"
    - DOCKER_IMAGE="klfitter/klfitter-buildenv:ubuntu20.04-root6.24.00-bat0.9.4.1"


# List of commands to be executed before the CI jobs:
#   - Pull the ROOT docker image.
#   - Start a docker container with that image, mount the
#       TRAVIS_BUILD_DIR within the docker image, and use it as
#       the working directory.
#   - List all active docker containers.
#   - Test commands, such as ROOT within the docker image, and
#       the exported environment variables KLF_SOURCE_DIR and
#       KLF_BUILD_DIR.
#   - Create the necessary directories.
before_install:
  - echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker pull $DOCKER_IMAGE
  - docker run -i -d --name build -v $TRAVIS_BUILD_DIR:/user/docker/src -w /user/docker/build $DOCKER_IMAGE
  - docker ps -a
  - docker exec build root --version
  - docker exec build ls -lR /user/docker


# Before the deployment step, build the doxygen documentation
# into the doc/html/ subdirectory.
before_deploy:
  - cd $TRAVIS_BUILD_DIR
  - doxygen doc/Doxyfile 2>&1


# Definiton of the actual CI jobs. We build KLFitter with two
# different scenarios:
# 1. Make a fully automatized build of KLFitter and BAT using
#    cmake. This downloads and compiles BAT via cmake, and builds
#    and links KLFitter against it. Run unit tests afterwards and
#    verify their output.
# 2. Download and compile BAT with the external shell script
#    CompileBAT.sh. Then configure the KLFitter build via cmake
#    and pick up that pre-built version of BAT. Run unit tests
#    afterwards and verify their output.
jobs:
  include:
    - env:
        - KLF_CMAKE_OPTS="-DKLF_INSTALL_TESTS=TRUE"
      script:
        - docker exec build cmake ${KLF_CMAKE_OPTS} ../src
        - docker exec build make
        - docker exec build ./test-bin/unit_tests.exe
        - docker exec build ./test-bin/test-ljets-lh.exe ${KLF_SOURCE_DIR} 2>&1 |tee test-output.txt
        - docker exec build test-output.txt ../src/tests/integration/output-ref-ljets-lh.txt
    - stage: deploy
      script: skip
      if: branch = master AND repo = KLFitter/KLFitter AND NOT type = pull_request
      deploy:
        provider: pages
        repo: KLFitter/KLFitter.github.io
        target_branch: master
        local_dir: doc/html
        token: $DOC_TOKEN
        keep-history: true
        strategy: git
        verbose: true
        allow_empty_commit: true
